{# src/OC/UserBundle/Resources/views/layout.html.twig #}

{# On ï¿½tend notre layout #}
{% extends "::layout.html.twig" %}

{% block title %}
    {{ pageProfile.name }}
{% endblock %}

{% block bellowHeader %}
<div id="profileApp" >
    <base href=" " />
    {% if pageProfile.enabled == true %}
        
    {# display profile header #}
    <section class="profile" ng-controller="profileController as profile" >
        <div id="profileHeaderContainer">
            <div class="banner">
                {% if pageProfile.coverImage != null %}
                    <img src="{{ asset(pageProfile.coverImage.webPath("1500x500")) }}" alt="{{ pageProfile.coverImage.alt }}">
                {% endif %}
                <div class="overlay"></div>
            </div>                
            <div class="profile-details">
                <a class="avatar"  href="#" title="">
                  <img src="{{ asset(pageProfile.profilImage.webPath("70x70")) }}" alt="{{ pageProfile.profilImage.alt }}">
                </a>
                <h1 class="username">{{ pageProfile.name }}</h1>
                <p class="bio">{{ pageProfile.description }}</p>
                {% if is_granted('ROLE_USER') %}
                    {% if isHownProfile == true %}
                        {{ form(editProfileForm) }}
                        <a id="editButton" class="button green" ng-click="profile.getEditProfileForm()" >
                            Edit profile
                        </a>
                    {% else %}
                        {{ form(followForm) }}
                        {% if is_granted("ROLE_ADMIN") %}
                            {{ form(setModeratorForm) }}
                        {% endif %}
                        <a id="followButton" class="button green " ng-click="profile.patchFollow()" >
                            {% if isFollowing == true %}
                                unfollow
                            {% else %}
                                follow
                            {% endif %}
                        </a>
                    {% endif %} 
                    {# report and delete image request form #}                            
                    {% if is_granted("ROLE_MODERATOR") and isHownProfile == false %}                
                        <form ng-model="profile.reportData" ng-submit="profile.postDisableRequest({{ pageProfile.id }})" >
                            <select ng-model="profile.reportData.reasonId">
                            {% for reason in reportReasonList %}
                                <option value="{{ reason.id }}">{{ reason.name }}</option>
                            {% endfor %}
                            </select>
                            <textarea ng-model="profile.reportData.details">More details...</textarea>
                            <input type="submit" value="Delete"/>
                        </form>
                        {{ form(disableTicketForm) }}                                                
                    {% elseif isHownProfile == false %}
                        <form ng-model="profile.reportData" ng-submit="profile.postReport({{ pageProfile.id }})" >
                            <select ng-model="profile.reportData.reasonId">
                            {% for reason in reportReasonList %}
                                <option value="{{ reason.id }}">{{ reason.name }}</option>
                            {% endfor %}
                            </select>
                            <textarea ng-model="profile.reportData.details">More details...</textarea>
                            <input type="submit" value="send report"/>
                        </form>
                        {{ form(reportTicketForm) }}            
                    {% endif %}
       
                {% endif %}
                {% if is_granted("ROLE_ADMIN") and isHownProfile == false %}                    
                        <a id="setModeratorButton" class="button follow" ng-click="profile.patchModerator({{ pageProfile.id }})">{% if isModerator == true %}unset moderator{% else %}Set moderator{% endif %}</a>
                {% endif %}   

                <ul class="details">
                    <li>
                        <strong>Following</strong>
                        {% if pageProfile.followingNb != null %}{{ pageProfile.followingNb }}{% else %}0{% endif %}
                    </li>
                    <li>
                        <strong>Followers</strong>
                        {% if pageProfile.followersNb != null %}{{ pageProfile.followersNb }}{% else %}0{% endif %}
                    </li>                                                         
                    <li class="link">
                        <a href="#" title="">{{ pageProfile.contact }}</a>                    
                    </li>
                </ul>
            </div>
        </div>
        <div id="editProfilContainer"></div>
    </section>
    
    {# display galery #}
    <section class="profile-galery">        
        <div class="content">
            <a target="_self" href="{{ path('pp_user_gallery', {'slug':pageProfile.slug})}}"><h1>Gallery ({{ galleryImagesNb }} picture{% if galleryImagesNb > 0 %}s{% endif %})</h1></a>
            {% set break = false %}
            <ul>
            {% for proposition in galleryImages if not break %}
                <li>
                    <a target="_self" href="{{ path('pp_request_view', {'slug':proposition.imageRequest.slug}) }}"><img src="{{ asset(proposition.image.webPath("single")) }}" alt="{{ proposition.image.alt }}"></a>                    
                </li>
               {% if loop.index >= 4  %}{% set break = true %}{% endif %}
               {% if loop.index >= 3 and galleryImagesNb > 4 %}{% set break = true %}{% endif %}
            {% endfor %}

            {% if galleryImagesNb > 4  %}
                <li>
                    <a target="_self" href="{{ path('pp_user_gallery', {'slug':pageProfile.slug})}}" class="more">                    
                        +{{ galleryImagesNb-3 }}             
                    </a>
                </li>
            {% endif %}
            </ul>
        </div>
    </section>
    {% endif %}
{% endblock %}

{% block body %}   
    <div class="main-left" >
       
        {% if pageProfile.enabled == true %}
            
            {#{% if isHownProfile == true %}{{ include("PPRequestBundle:Request:addRequestForm.html.twig") }}{% endif %}#}

            <div ng-controller="requestsController as requests" ng-init="requests.init({{ pageProfile.id }})" >

                {{ form(loadRequestForm) }}
                {{ form(upvoteRequestForm) }}
                <div id="loadPage1"></div>
                <article class="request"></article>

                <div class="load-content"  id="loadingGif" >
                    <span class="bubble"></span>
                </div>
            </div>
        {% else %}    
            {# if user disabled #}
            <h2>This user have been deleted</h2>
            <p>reason : {{ pageProfile.disableTicket.reason.name }}</p>
            <p>Details : {{ pageProfile.disableTicket.details }}</p>
        {% endif %}
    </div>        
{% endblock %}


{% block js %}
    {% javascripts filter='?yui_js' '@PPUserBundle/Resources/public/js/profileApp.js' %}
      <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}    
{% endblock %}