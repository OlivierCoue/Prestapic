{# src/OC/UserBundle/Resources/views/layout.html.twig #}

{# On ï¿½tend notre layout #}
{% extends "::layout.html.twig" %}

{% block title %}
    {{ pageProfile.name }}
{% endblock %}

{% block bellowHeader %}
<div id="profileApp" >
    
    <base href=" " />
    {% if pageProfile.enabled == true %}
    <script>
        var d = document.getElementById("header");
        d.className += " profile";
    </script>    
    {# display profile header #}
    <section class="profile" ng-controller="profileController as profile" >
        <div id="profileHeaderContainer">
            <div class="profile-cover">
                {% if pageProfile.coverImage != null %}
                    <div class="banner" style="background-image: url({{ asset(pageProfile.coverImage.webPath("1500x500")) }})"></div>
                    <div class="overlay"></div> 
                {% endif %}
            </div>      
            <div class="profile-details">
                <div class="avatar">
                  <img src="{{ asset(pageProfile.profilImage.webPath("70x70")) }}" alt="{{ pageProfile.profilImage.alt }}">
                </div>
                <h1 class="username">{{ pageProfile.name }}</h1>
                <div class="screenname">@{{ pageProfile.username }}</div>
                <p class="bio">{{ pageProfile.description }}</p>
                <div class="profile-actions">
                    {% if is_granted('ROLE_USER') %}
                        {% if isHownProfile == true %}
                            {{ form(editProfileForm) }}
                            <a href="" id="editButton" class="button green" ng-click="profile.getEditProfileForm()" >
                                Edit profile
                            </a>
                        {% else %}
                            {{ form(followForm) }}
                            {{ form(blockForm) }}
                            {% if is_granted("ROLE_ADMIN") %}
                                {{ form(setModeratorForm) }}
                            {% endif %}
                            <a href="" id="followButton" class="button green " ng-click="profile.patchFollow()" >{% if isFollowing == true %}Unfollow{% else %}Follow{% endif %}</a>
                        {% endif %}
                    {% endif %}                                                                                                                

                    {% if isHownProfile == false %}
                        {% if is_granted('ROLE_USER') %}

                        <div class="dropdown-container profile-options stopPropagation">
                            <a href="" ng-click="profile.showProfileOptions()" class="button"></a>
                            <ul class="dropdown-choices" id="profileOptions" style="display: none;">
                                <li class="dropdown-cat">
                                    <a href="" id="blockButton" class="dropdown-choice" ng-click="profile.patchBlock({{ pageProfile.id }})" >
                                        {% if isBlocked == true %}Unblock{% else %}Block{% endif %}
                                    </a>
                                    <a href="" class="dropdown-choice" ng-click="profile.showReportPopup({{ pageProfile.id }}, 3)">
                                        Report
                                    </a>
                                </li>
           
                                {% if is_granted("ROLE_ADMIN") %}
                                <li class="dropdown-cat">
                                    <div class="dropdown-cat-title">Moderator commands</div>
                                    <a href="" id="setModeratorButton" class="dropdown-choice" ng-click="profile.patchModerator({{ pageProfile.id }})">{% if isModerator == true %}Unset moderator{% else %}Set moderator{% endif %}</a>
                                </li>
                                {% endif %}
                            </ul>
                        </div>

                    {% endif %}
                {% endif %}
                </div>

                <ul class="details">
                    <li>
                        <strong>Following</strong>
                        {% if pageProfile.followingNb != null %}{{ pageProfile.followingNb }}{% else %}0{% endif %}
                    </li>
                    <li>
                        <strong>Followers</strong>
                        {% if pageProfile.followersNb != null %}{{ pageProfile.followersNb }}{% else %}0{% endif %}
                    </li>                                                         
                    <li class="link">
                        <a href="http://{{ pageProfile.contact }}" target="_blank" rel="nofollow" title="">{{ pageProfile.contact }}</a>                    
                    </li>
                </ul>
            </div>
        </div>
        <div id="editProfilContainer"></div>
    </section>
    
    {# display galery #}
    <section class="profile-galery" ng-controller="galleryController as gallery">        
        <div class="content">
            <a target="_self" href="{{ path('pp_user_gallery', {'slug':pageProfile.slug})}}"><h1>Gallery ({{ galleryImagesNb }} picture{% if galleryImagesNb > 0 %}s{% endif %})</h1></a>
            {% set break = false %}
            <ul>
            {% for proposition in galleryImages if not break %}
                <li>
                    <a ng-click="gallery.showPopup({{ proposition.id }})" ng-href="{{ asset(proposition.image.webPath("original")) }}"><img src="{{ asset(proposition.image.webPath("single")) }}" alt="{{ proposition.image.alt }}"></a>                    
                </li>
               {% if loop.index >= 4  %}{% set break = true %}{% endif %}
               {% if loop.index >= 3 and galleryImagesNb > 4 %}{% set break = true %}{% endif %}
            {% endfor %}

            {% if galleryImagesNb > 4  %}
                <li>
                    <a target="_self" href="{{ path('pp_user_gallery', {'slug':pageProfile.slug})}}" class="more">                    
                        +{{ galleryImagesNb-3 }}             
                    </a>
                </li>
            {% endif %}
            </ul>
        </div>
    </section>
    {% endif %}
{% endblock %}

{% block body %}   
    <div class="main-left" >
       
        {% if pageProfile.enabled == true %}
            
            {#{% if isHownProfile == true %}{{ include("PPRequestBundle:Request:addRequestForm.html.twig") }}{% endif %}#}

            <div ng-controller="requestsController as requests" ng-init="requests.init({{ pageProfile.id }})" >

                {{ form(loadRequestForm) }}
                {{ form(upvoteRequestForm) }}
                <div id="loadPage1"></div>
                <article class="request"></article>

                <div class="load-content"  id="loadingGif" >
                    <span class="bubble"></span>
                </div>
            </div>
        {% else %}    
            {# if user disabled #}
            <h2>This user have been deleted</h2>
            <p>reason : {{ pageProfile.disableTicket.reason.name }}</p>
            <p>Details : {{ pageProfile.disableTicket.details }}</p>
        {% endif %}
    </div>        
{% endblock %}


{% block js %}
    {% javascripts filter='?yui_js' '@PPUserBundle/Resources/public/js/profileApp.js' %}
      <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}    
{% endblock %}