jQuery.fn.preventDoubleSubmission=function(){$(this).on("submit",function(b){var a=$(this);if(a.data("submitted")===true){b.preventDefault()}else{a.data("submitted",true)}});return this};$(".addRequestForm").preventDoubleSubmission();$("#pp_requestbundle_image_request_title").one("focus",function(){$("#requestFormRest").slideToggle();$(".content").removeClass("init")});$(".signInUp").click(function(){$("#signInUpOver").fadeIn()});$("#signInUpOverClose").click(function(){$("#signInUpOver").fadeOut()});
var headerApp=angular.module("headerApp",[]);headerApp.config(["$locationProvider",function(a){a.html5Mode(true)}]);headerApp.service("FayeClient",function(){return new Faye.Client("http://alexandrejolly.com:3000/")});headerApp.run(["$rootScope","FayeClient","$http",function(a,e,f){a.notifications=[];var d=document.forms.pp_notification_api_get_thread_form;if(d!=null){var b=d.action;var c=null;f.get(b).then(function(g){var h=JSON.parse(g.data);c=h.notifThreadSlug;e.subscribe("/notification/"+c,function(i){a.$broadcast("notification",i)})},function(g){console.log("Request failed : "+g.statusText)})}}]);headerApp.filter("reverse",function(){return function(a){return a.slice().reverse()}});var notificationListIsOpen=false;var userMenuIsOpen=false;var filterListIsOpen=false;var haveOpenMessage=false;var messageIsOpen=false;headerApp.controller("headerController",["$scope","$http","$compile","$location","$window",function(n,l,f,i,d){$(".fixeBodyHover").mouseover(function(){$("#body").css("position","fixed")});$(".fixeBodyHover").mouseout(function(){$("#body").css("position","absolute")});var m=false;var k=null;n.showMoreNotification=true;var e=function(){if(messageIsOpen){c()}if(notificationListIsOpen){j()}if(filterListIsOpen){g()}if(userMenuIsOpen){a()}$("#searchUser").css("display","none")};this.showMessage=function(){e();var o=document.getElementById("messageApp");document.getElementById("body").style.position="fixed";if(o!=null){h(true);if(!haveOpenMessage){angular.element(document).ready(function(){angular.bootstrap(o,["messageApp"])});haveOpenMessage=true}o.style.display="block";messageIsOpen=true}};var c=function(){document.getElementById("body").style.position="relative";if(document.getElementById("messageApp")!=null){document.getElementById("messageApp").style.display="none"}h(false);messageIsOpen=false};var h=function(q){var o=document.forms.pp_user_api_patch_is_in_message_form;if(o!=null){var p={mode:q};l({method:"PATCH",url:o.action,data:JSON.stringify(p)}).then(function(r){},function(r){console.log("Request failed : "+r.statusText)})}};var j=function(){document.getElementById("notificationList").style.display="none";$("#notificationButton").removeClass("alert");$("#notificationButton").removeClass("open");document.getElementById("notificationsNb").innerHTML=0;var o=document.forms.pp_notification_api_patch_viewed_form;if(o!=null){var q=[];l({method:"PATCH",url:o.action,data:JSON.stringify(q)}).then(function(r){},function(r){console.log("Request failed : "+r.statusText)})}for(var p in n.notifications){if(n.notifications.hasOwnProperty(p)){n.notifications[p].isViewed=true}}notificationListIsOpen=false};this.showNotifications=function(){if(!notificationListIsOpen){e();document.getElementById("notificationList").style.display="block";$("#notificationButton").addClass("open");if(!m){var o=document.forms.pp_notification_api_get_notification_form;if(o!=null){l.get(o.action).then(function(q){$("#loadingNotif").css("display","none");k=q.data.showMoreApiUrl;if(q.data.notifications.length==0){$("#noNotification").css("display","block")}for(var p=0;p<q.data.notifications.length;p++){n.notifications.push(q.data.notifications[p])}if(!q.data.showMore){n.showMoreNotification=false}m=true},function(p){console.log("Request failed : "+p.statusText)})}}notificationListIsOpen=true;userMenuIsOpen=false}else{e()}};this.showMoreNotifications=function(){if(notificationListIsOpen&&k!=null){l.get(k).then(function(p){k=p.data.showMoreApiUrl;for(var o=0;o<p.data.notifications.length;o++){n.notifications.push(p.data.notifications[o])}if(!p.data.showMore){n.showMoreNotification=false}},function(o){console.log("Request failed : "+o.statusText)})}};this.patchNotificationClicked=function(r){e();var p=n.notifications[r];var q=p.setClickedUrl;var s=[];if(!p.isCliked){l({method:"PATCH",url:q,data:JSON.stringify(s)}).then(function(t){},function(t){console.log("Request failed : "+t.statusText)})}if(p.type!=4){d.location.href=p.redirectUrl}else{this.showMessage();var o={id:p.messageThreadId,target:{id:p.authorId,name:p.authorName,image:p.authorImg}};angular.element(document.getElementById("messageApp")).scope().$emit("showNewMessage",o)}};this.showUserMenu=function(){if(!userMenuIsOpen){e();document.getElementById("userMenu").style.display="block";userMenuIsOpen=true}else{e()}};var a=function(){document.getElementById("userMenu").style.display="none";userMenuIsOpen=false};this.showFilterList=function(){if(!filterListIsOpen){e();document.getElementById("filterList").style.display="block";filterListIsOpen=true;$("#filterButton").addClass("open")}else{g()}};var g=function(){if(filterListIsOpen){document.getElementById("filterList").style.display="none";$("#filterButton").removeClass("open");filterListIsOpen=false}document.getElementById("searchOptions").style.display="none"};this.showSearchOptions=function(){document.getElementById("searchOptions").style.display="block";$("#searchUser").css("display","block")};n.$on("notification",function(p,o){if(m){n.notifications.unshift(o.notification);n.$apply();$("#noNotification").css("display","none")}document.getElementById("notificationsNb").innerHTML=parseInt(document.getElementById("notificationsNb").innerHTML)+1;$("#notificationButton").addClass("alert")});$("html").click(function(){e()});$(".stopPropagation").click(function(o){o.stopPropagation()});function b(){function o(p){angular.element(document.getElementById("headerController")).scope().leave()}window.onbeforeunload=o}$(document).ready(function(){b()});n.leave=function(){e()}}]);headerApp.controller("filtersController",["$scope","$http","$compile","$location","$window",function(a,f,b,e,d){this.showFiltersTags=function(){c();document.getElementById("filtersTags").style.display="block";$("#filtersTagsButton").addClass("open")};this.showFiltersCat=function(){c();document.getElementById("filtersCat").style.display="block";$("#filtersCatButton").addClass("open")};var c=function(){document.getElementById("filtersTags").style.display="none";document.getElementById("filtersCat").style.display="none";$("#filtersCatButton").removeClass("open");$("#filtersTagsButton").removeClass("open")};this.categoriesList=[];this.addCategory=function(h,g){if(this.categoriesList[h]==null){this.categoriesList[h]=g}else{delete this.categoriesList[h]}};this.tagsListClicked=[];this.tagsListStr=null;this.tagList=[];this.addTag=function(h,g){if(this.tagsListClicked[h]==null){$("#tag_"+h).addClass("choosen");this.tagsListClicked[h]=g}else{$("#tag_"+h).removeClass("choosen");delete this.tagsListClicked[h]}};this.tagStrToArray=function(){var j=[];if(this.tagsListStr){this.tagsListStr=this.tagsListStr.toLowerCase()+",";this.tagsListStr=this.tagsListStr.replace(" ","");var i="";var h=this.tagsListStr.split("");h.forEach(function(k){if(k!=","){i+=k}else{if(i){j.push(i)}i=""}})}this.tagsListClicked.forEach(function(k){j.push(k)});var g=[];$.each(j,function(k,l){if($.inArray(l,g)===-1){g.push(l)}});this.tagList=g};this.conceringMe=false;this.searchQuery="";this.submitForm=function(){this.tagStrToArray();var m=document.getElementsByName("search_action")[0].value;var l="search_query="+this.searchQuery;var k="tags=";for(var h=0;h<this.tagList.length;h++){k+=this.tagList[h];if(h<this.tagList.length-1){k+="+"}}var g="categories=";for(var h=0;h<this.categoriesList.length;h++){if(this.categoriesList[h]){g+=this.categoriesList[h];if(h<this.categoriesList.length-1){g+="+"}}}var j="";if(this.conceringMe){j="me=true"}d.location.href=m+"?"+l+"&"+k+"&"+g+"&"+j}}]);
containerApp.directive("bnLazySrc",["$window","$document",function(f,d){function c(q){function l(u,s){if(!q.is(":visible")){return !1}null===g&&(g=q.height());var o=q.offset().top,n=o+g;return s>=o&&o>=u||s>=n&&n>=u||u>=o&&n>=s}function k(){p=!0,h()}function j(e){m=e,p&&h()}function h(){q[0].src=m}var m=null,p=!1,g=null;return{isVisible:l,render:k,setSource:j}}function b(j,h,g){var i=new c(h);a.addImage(i),g.$observe("bnLazySrc",function(e){i.setSource(e)}),j.$on("$destroy",function(){a.removeImage(i)})}var a=function(){function w(g){q.push(g),j||k(),e||B()}function n(h){for(var g=0;g<q.length;g++){if(q[g]===h){q.splice(g,1);break}}q.length||(H(),F())}function C(){if(!j){var g=I.height();g!==G&&(G=g,k())}}function y(){for(var K=[],v=[],s=E.height(),p=E.scrollTop(),m=p,z=m+s+500,h=0;h<q.length;h++){var g=q[h];g.isVisible(m,z)?K.push(g):v.push(g)}for(var h=0;h<K.length;h++){K[h].render()}q=v,H(),q.length||F()}function H(){clearTimeout(j),j=null}function k(){j=setTimeout(y,D)}function B(){e=!0,E.on("resize.bnLazySrc",J),E.on("scroll.bnLazySrc",J),A=setInterval(C,x)}function F(){e=!1,E.off("resize.bnLazySrc"),E.off("scroll.bnLazySrc"),clearInterval(A)}function J(){j||k()}var q=[],j=null,D=100,E=$(f),I=d,G=I.height(),A=null,x=2000,e=!1;return{addImage:w,removeImage:n}}();return{link:b,restrict:"A"}}]);
var appLoaded=false;var readyForMessage=true;var messageApp=angular.module("messageApp",["ngRoute","ngSanitize"]);messageApp.config(["$locationProvider",function(a){a.html5Mode(true)}]);messageApp.service("FayeClient",function(){return new Faye.Client("http://alexandrejolly.com:3000/")});messageApp.run(["$rootScope","FayeClient","$http",function(a,d,e){a.currentUser={};var b=document.forms.pp_message_api_get_current_user_form.action;var c=null;a.$on("showNewMessage",function(g,f){c=f;if(appLoaded){a.$emit("loadConversation",a.currentUser.threadList[c.id]);a.currentThread=a.currentUser.threadList[c.id]}});e.get(b).then(function(f){a.currentUser=f.data;d.subscribe("/messages/"+a.currentUser.id,function(g){a.$broadcast("newMessage",g)});if(c!=null){a.$emit("loadConversation",a.currentUser.threadList[c.id])}$(".chat-conversation").scrollTop($(".chat-conversation").height());appLoaded=true},function(f){console.log("Request failed : "+f.statusText)})}]);messageApp.controller("inboxController",["$scope","$rootScope","$http",function(b,a,c){a.$on("newMessage",function(e,d){if(d.action=="newThread"){a.currentUser.threadList[d.message.threadId]=d.newThread;a.currentUser.threadList[d.message.threadId].haveReceiveMessage=true}else{if(d.action=="newMessage"){}}b.$apply()});this.gotToConversation=function(d){a.$emit("loadConversation",d)}}]);messageApp.controller("searchController",["$scope","$rootScope","$http",function(c,a,d){this.search=null;c.userSearchList=[];var b=document.forms.pp_user_api_get_search_user_form.action;this.searchUser=function(){if(this.search.length>0){d.get(b+"?search="+this.search).then(function(f){c.userSearchList=[];for(var e=0;e<f.data.users.length;e++){c.userSearchList.push(f.data.users[e])}},function(e){console.log("Request failed : "+e.statusText)})}else{c.userSearchList=[]}};this.getThread=function(f){var e={target:f};a.$emit("loadConversation",e)}}]);messageApp.controller("chatController",["$scope","$rootScope","$http",function(e,b,g){e.conversation=[];e.messageContent=null;var a=function(){$("#conversation").scrollTop($("#conversation")[0].scrollHeight)};b.$on("loadConversation",function(j,h){var i=true;$("#chatTitle").html(h.target.name);if(h.id==null){i=false;for(var k in b.currentUser.threadList){if(b.currentUser.threadList[k].target.id==h.target.id){h=b.currentUser.threadList[k];i=true;e.currentThread=h;break}}if(!i){e.currentThread=h}}if(i){if(!b.currentUser.threadList[h.id].haveReceiveMessage&&(b.currentUser.threadList[h.id]==null||b.currentUser.threadList[h.id].messageList.length>0)){e.currentThread=h}else{if(i){b.currentUser.threadList[h.id].haveReceiveMessage=false;readyForMessage=false;g.get(b.currentUser.getConversationApiUrl+"?threadId="+h.id+"&page=1").then(function(l){e.currentThread=h;b.currentUser.threadList[h.id].haveNewMessage=false;b.currentUser.threadList[h.id].messageList=l.data.messages;setTimeout(a,10);readyForMessage=true},function(l){console.log("Request failed : "+l.statusText)})}}}if(!e.$$phase){e.$apply();$("#conversation").scrollTop($("#conversation")[0].scrollHeight)}setTimeout(a,10)});this.loadMore=function(){e.currentThread.page++;if(e.currentThread.id!=null){g.get(b.currentUser.getConversationApiUrl+"?threadId="+e.currentThread.id+"&page="+e.currentThread.page).then(function(h){for(var j=h.data.messages.length-1;j>-1;j--){b.currentUser.threadList[e.currentThread.id].messageList.unshift(h.data.messages[j])}},function(h){console.log("Request failed : "+h.statusText)})}};b.$on("newMessage",function(i,h){if(b.currentUser.threadList[h.message.threadId].messageList.length==0){b.currentUser.threadList[h.message.threadId].haveReceiveMessage=true}b.currentUser.threadList[h.message.threadId].messageList.push(h.message);b.currentUser.threadList[h.message.threadId].lastMessage=h.message;e.$apply();$("#conversation").scrollTop($("#conversation")[0].scrollHeight)});var f=function(){if(e.messageContent){myData={threadId:e.currentThread.id,targetId:e.currentThread.target.id,messageContent:e.messageContent};if(readyForMessage){var h={content:e.messageContent,authorName:b.currentUser.name,messageFromUs:true};if(e.currentThread.id!=null){b.currentUser.threadList[e.currentThread.id].messageList.push(h)}g({method:"POST",url:b.currentUser.postMessageApiUrl,data:JSON.stringify(myData)}).then(function(i){if(e.currentThread.id==null){e.currentThread=i.data.newThread;if(b.currentUser.threadList[i.data.newThread.id]==null){b.currentUser.threadList[i.data.newThread.id]=i.data.newThread}}},function(i){console.log("Request failed : "+i.statusText)});e.messageContent=null;setTimeout(a,10)}}};this.callSendMessage=function(){f()};var d=0;$("#chatTextArea").elastic();$("#chatTextArea").on("keydown",function(h){if(h.keyCode==13){if(!h.shiftKey){f()}else{setTimeout(a,10)}}});function c(){var k=document.getElementById("chatTextArea");var j=(k.cols);var h=(k.value.length/j);var i=(k.value.split("\r\n"));return Math.round(h)+1}}]);var isInSearch=false;$("#searchButton").click(function(){if(!isInSearch){$("#inboxBlock").css("display","none");$("#searchBlock").css("display","inline-block");isInSearch=true}else{$("#inboxBlock").css("display","block");$("#searchBlock").css("display","none");isInSearch=false}});
(function(a){a.fn.extend({elastic:function(){var b=["paddingTop","paddingRight","paddingBottom","paddingLeft","fontSize","lineHeight","fontFamily","width","fontWeight","border-top-width","border-right-width","border-bottom-width","border-left-width","borderTopStyle","borderTopColor","borderRightStyle","borderRightColor","borderBottomStyle","borderBottomColor","borderLeftStyle","borderLeftColor"];return this.each(function(){if(this.type!=="textarea"){return false}var g=a(this),c=a("<div />").css({position:"absolute",display:"none","word-wrap":"break-word"}),j=parseInt(g.css("line-height"),10)||parseInt(g.css("font-size"),"10"),l=48,k=210,d=0;if(k<0){k=Number.MAX_VALUE}c.appendTo(g.parent());var f=b.length;while(f--){c.css(b[f].toString(),g.css(b[f].toString()))}function h(){curatedWidth=Math.floor(parseInt(g.width(),10));if(c.width()!==curatedWidth){c.css({width:curatedWidth+"px"});e(true)}}function m(i,o){var n=Math.floor(parseInt(i,10));if(g.height()!==n){g.css({height:n+"px",overflow:o});g.trigger("resize")}}function e(p){var o=g.val().replace(/&/g,"&amp;").replace(/ {2}/g,"&nbsp;").replace(/<|>/g,"&gt;").replace(/\n/g,"<br />");var i=c.html().replace(/<br>/ig,"<br />");if(p||o+"&nbsp;"!==i){c.html(o+"&nbsp;");if(Math.abs(c.height()+j-g.height())>3){var n=c.height()+j;if(n>=k){m(k,"auto")}else{if(n<=l){m(l,"hidden")}else{m(n,"hidden")}}}}}g.css({overflow:"hidden"});g.bind("keyup change cut paste",function(){e()});$(window).bind("resize",h);g.bind("resize",h);g.bind("update",e);g.bind("blur",function(){if(c.height()<k){if(c.height()>l){g.height(c.height())}else{g.height(l)}}});g.bind("input paste",function(i){setTimeout(e,250)});e()})}})})(jQuery);