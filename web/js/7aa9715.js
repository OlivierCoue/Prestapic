$("#pp_requestbundle_image_request_title").one("focus",function(){$("#requestFormRest").slideToggle();$(".content").removeClass("init")});$(".signInUp").click(function(){$("#signInUpOver").fadeIn()});$("#signInUpOverClose").click(function(){$("#signInUpOver").fadeOut()});
var headerApp=angular.module("headerApp",[]);headerApp.config(["$locationProvider",function(a){a.html5Mode(true)}]);headerApp.service("FayeClient",function(){return new Faye.Client("http://localhost:3000/")});headerApp.run(["$rootScope","FayeClient","$http",function(a,e,f){a.notifications=[];var d=document.forms.pp_notification_api_get_thread_form;if(d!=null){var b=d.action;var c=null;f.get(b).then(function(g){var h=JSON.parse(g.data);c=h.notifThreadSlug;e.subscribe("/notification/"+c,function(i){a.$broadcast("notification",i)})},function(g){console.log("Request failed : "+g.statusText)})}}]);headerApp.filter("reverse",function(){return function(a){return a.slice().reverse()}});var notificationListIsOpen=false;var userMenuIsOpen=false;var filterListIsOpen=false;var haveOpenMessage=false;var messageIsOpen=false;headerApp.controller("headerController",["$scope","$http","$compile","$location","$window",function(m,k,e,h,c){var l=false;var j=null;m.showMoreNotification=true;var d=function(){if(messageIsOpen){b()}if(notificationListIsOpen){i()}if(filterListIsOpen){f()}if(userMenuIsOpen){a()}};this.showMessage=function(){d();var n=document.getElementById("messageApp");if(n!=null){g(true);if(!haveOpenMessage){angular.element(document).ready(function(){angular.bootstrap(n,["messageApp"])});haveOpenMessage=true}n.style.display="block";messageIsOpen=true}};var b=function(){if(document.getElementById("messageApp")!=null){document.getElementById("messageApp").style.display="none"}g(false);messageIsOpen=false};var g=function(p){var n=document.forms.pp_user_api_patch_is_in_message_form;if(n!=null){var o={mode:p};k({method:"PATCH",url:n.action,data:JSON.stringify(o)}).then(function(q){},function(q){console.log("Request failed : "+q.statusText)})}};var i=function(){document.getElementById("notificationList").style.display="none";$("#notificationButton").removeClass("alert");$("#notificationButton").removeClass("open");document.getElementById("notificationsNb").innerHTML=0;var n=document.forms.pp_notification_api_patch_viewed_form;if(n!=null){var p=[];k({method:"PATCH",url:n.action,data:JSON.stringify(p)}).then(function(q){},function(q){console.log("Request failed : "+q.statusText)})}for(var o in m.notifications){if(m.notifications.hasOwnProperty(o)){m.notifications[o].isViewed=true}}notificationListIsOpen=false};this.showNotifications=function(){if(!notificationListIsOpen){d();document.getElementById("notificationList").style.display="block";$("#notificationButton").addClass("open");if(!l){var n=document.forms.pp_notification_api_get_notification_form;if(n!=null){k.get(n.action).then(function(p){j=p.data.showMoreApiUrl;for(var o=0;o<p.data.notifications.length;o++){m.notifications.push(p.data.notifications[o])}if(!p.data.showMore){m.showMoreNotification=false}l=true},function(o){console.log("Request failed : "+o.statusText)})}}notificationListIsOpen=true;userMenuIsOpen=false}else{d()}};this.showMoreNotifications=function(){if(notificationListIsOpen&&j!=null){k.get(j).then(function(o){j=o.data.showMoreApiUrl;for(var n=0;n<o.data.notifications.length;n++){m.notifications.push(o.data.notifications[n])}if(!o.data.showMore){m.showMoreNotification=false}},function(n){console.log("Request failed : "+n.statusText)})}};this.patchNotificationClicked=function(p){d();var n=m.notifications[p];var o=n.setClickedUrl;var q=[];if(!n.isCliked){k({method:"PATCH",url:o,data:JSON.stringify(q)}).then(function(r){},function(r){console.log("Request failed : "+r.statusText)})}if(n.type!=4){c.location.href=n.redirectUrl}else{this.showMessage();angular.element(document.getElementById("messageApp")).scope().$emit("showNewMessage",n.authorId)}};this.showUserMenu=function(){if(!userMenuIsOpen){d();document.getElementById("userMenu").style.display="block";userMenuIsOpen=true}else{d()}};var a=function(){document.getElementById("userMenu").style.display="none";userMenuIsOpen=false};this.showFilterList=function(){if(!filterListIsOpen){d();document.getElementById("filterList").style.display="block";filterListIsOpen=true;$("#filterButton").addClass("open")}else{f()}};var f=function(){if(filterListIsOpen){document.getElementById("filterList").style.display="none";$("#filterButton").removeClass("open");filterListIsOpen=false}document.getElementById("searchOptions").style.display="none"};this.showSearchOptions=function(){document.getElementById("searchOptions").style.display="block"};m.$on("notification",function(o,n){if(l){m.notifications.unshift(n.notification);m.$apply()}document.getElementById("notificationsNb").innerHTML=parseInt(document.getElementById("notificationsNb").innerHTML)+1;$("#notificationButton").addClass("alert")});$("html").click(function(){d()});$(".stopPropagation").click(function(n){n.stopPropagation()})}]);
containerApp.directive("bnLazySrc",["$window","$document",function(f,d){function c(q){function l(u,s){if(!q.is(":visible")){return !1}null===g&&(g=q.height());var o=q.offset().top,n=o+g;return s>=o&&o>=u||s>=n&&n>=u||u>=o&&n>=s}function k(){p=!0,h()}function j(e){m=e,p&&h()}function h(){q[0].src=m}var m=null,p=!1,g=null;return{isVisible:l,render:k,setSource:j}}function b(j,h,g){var i=new c(h);a.addImage(i),g.$observe("bnLazySrc",function(e){i.setSource(e)}),j.$on("$destroy",function(){a.removeImage(i)})}var a=function(){function w(g){q.push(g),j||k(),e||B()}function n(h){for(var g=0;g<q.length;g++){if(q[g]===h){q.splice(g,1);break}}q.length||(H(),F())}function C(){if(!j){var g=I.height();g!==G&&(G=g,k())}}function y(){for(var K=[],v=[],s=E.height(),p=E.scrollTop(),m=p,z=m+s,h=0;h<q.length;h++){var g=q[h];g.isVisible(m,z)?K.push(g):v.push(g)}for(var h=0;h<K.length;h++){K[h].render()}q=v,H(),q.length||F()}function H(){clearTimeout(j),j=null}function k(){j=setTimeout(y,D)}function B(){e=!0,E.on("resize.bnLazySrc",J),E.on("scroll.bnLazySrc",J),A=setInterval(C,x)}function F(){e=!1,E.off("resize.bnLazySrc"),E.off("scroll.bnLazySrc"),clearInterval(A)}function J(){j||k()}var q=[],j=null,D=100,E=$(f),I=d,G=I.height(),A=null,x=2000,e=!1;return{addImage:w,removeImage:n}}();return{link:b,restrict:"A"}}]);
var appLoaded=false;var haveMessageThread=false;var currentMessageThreadId=null;var targetUserId=null;var postMessageUrl=null;var currentUser=null;var targetUser=null;var currentThread=null;var conversationUrl=null;var getThreadUrl=null;var conversationToLoad=null;var readyForMessage=false;var messageApp=angular.module("messageApp",["ngRoute"]);messageApp.config(["$locationProvider",function(a){a.html5Mode(true)}]);messageApp.service("FayeClient",function(){return new Faye.Client("http://localhost:3000/")});messageApp.run(["$rootScope","FayeClient","$http",function(a,d,e){console.log("run");var b=document.forms.pp_message_api_get_inbox_form.action;var c=null;a.$on("showNewMessage",function(g,f){c=f;if(appLoaded){a.$emit("loadConversation",f)}});e.get(b).then(function(f){currentUser=f.data.currentUser;a.currentUser=currentUser;a.inboxThreads=f.data.threads;conversationUrl=f.data.conversationUrl;postMessageUrl=f.data.postMessageUrl;getThreadUrl=f.data.getThreadUrl;d.subscribe("/messages/"+currentUser.id,function(g){a.$broadcast("newMessage",g)});if(c!=null){a.$emit("loadConversation",c)}appLoaded=true},function(f){console.log("Request failed : "+f.statusText)})}]);messageApp.controller("inboxController",["$scope","$rootScope","$http",function(b,a,c){a.$on("newMessage",function(f,e){if(e.action=="newThread"){b.inboxThreads.unshift(e.message)}else{if(e.action=="newMessage"){for(var d=0;d<b.inboxThreads.length;d++){if(b.inboxThreads[d].threadId==e.message.threadId){if(currentMessageThreadId!=e.message.threadId){b.inboxThreads[d].haveNewMessage=true}b.inboxThreads[d].message=e.message.content;break}}}}b.$apply()});this.gotToConversation=function(d){a.$emit("loadConversation",d.userId)}}]);messageApp.controller("searchController",["$scope","$rootScope","$http",function(c,a,d){this.search=null;c.userSearchList=[];var b=document.forms.pp_message_api_get_search_user_form.action;this.searchUser=function(){if(this.search.length>0){d.get(b+"?search="+this.search).then(function(f){c.userSearchList=[];for(var e=0;e<f.data.users.length;e++){c.userSearchList.push(f.data.users[e])}},function(e){console.log("Request failed : "+e.statusText)})}else{c.userSearchList=[]}};this.getThread=function(e){a.$emit("loadConversation",e.id)}}]);messageApp.controller("chatController",["$scope","$rootScope","$http",function(b,a,c){this.messageContent=null;a.$on("loadConversation",function(e,d){readyForMessage=false;c.get(getThreadUrl+"?targetId="+d).then(function(f){haveMessageThread=f.data.messageThreadFounded;currentThread=f.data.messageThread;targetUser=f.data.targetUser;if(haveMessageThread){for(var g=0;g<b.inboxThreads.length;g++){if(b.inboxThreads[g].threadId==currentThread.threadId){b.inboxThreads[g].haveNewMessage=false;break}}}b.currentThread={targetName:targetUser.name};b.conversation=[];if(haveMessageThread){c.get(conversationUrl+"?threadId="+currentThread.threadId).then(function(h){b.conversation=h.data.messages},function(h){console.log("Request failed : "+h.statusText)})}readyForMessage=true},function(f){console.log("Request failed : "+f.statusText)})});a.$on("newMessage",function(e,d){if(currentThread!=null&&d.message.threadId==currentThread.threadId){b.conversation.push(d.message);b.$apply()}});this.sendMessage=function(){var f=null;if(currentThread!=null){f=currentThread.threadId}myData={haveMessageThread:haveMessageThread,targetUserId:targetUser.id,currentMessageThreadId:f,messageContent:this.messageContent};if(readyForMessage){c({method:"POST",url:postMessageUrl,data:JSON.stringify(myData)}).then(function(g){if(!haveMessageThread){currentThread=g.data.newThread;haveMessageThread=true;b.inboxThreads.unshift(g.data.newThread)}},function(g){console.log("Request failed : "+g.statusText)});var d={content:this.messageContent,authorName:currentUser.name,messageFromUs:true};b.conversation.push(d);if(currentThread!=null){for(var e=0;e<b.inboxThreads.length;e++){if(b.inboxThreads[e].threadId==currentThread.threadId){b.inboxThreads[e].message=this.messageContent;b.inboxThreads[e].messageFromUs=true;break}}}this.messageContent=null}}}]);