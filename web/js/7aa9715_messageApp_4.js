var appLoaded=false;var haveMessageThread=false;var currentMessageThreadId=null;var targetUserId=null;var postMessageUrl=null;var currentUser=null;var targetUser=null;var currentThread=null;var conversationUrl=null;var getThreadUrl=null;var conversationToLoad=null;var readyForMessage=false;var messageApp=angular.module("messageApp",["ngRoute"]);messageApp.config(["$locationProvider",function(a){a.html5Mode(true)}]);messageApp.service("FayeClient",function(){return new Faye.Client("http://localhost:3000/")});messageApp.run(["$rootScope","FayeClient","$http",function(a,d,e){console.log("run");var b=document.forms.pp_message_api_get_inbox_form.action;var c=null;a.$on("showNewMessage",function(g,f){c=f;if(appLoaded){a.$emit("loadConversation",f)}});e.get(b).then(function(f){currentUser=f.data.currentUser;a.currentUser=currentUser;a.inboxThreads=f.data.threads;conversationUrl=f.data.conversationUrl;postMessageUrl=f.data.postMessageUrl;getThreadUrl=f.data.getThreadUrl;d.subscribe("/messages/"+currentUser.id,function(g){a.$broadcast("newMessage",g)});if(c!=null){a.$emit("loadConversation",c)}appLoaded=true},function(f){console.log("Request failed : "+f.statusText)})}]);messageApp.controller("inboxController",["$scope","$rootScope","$http",function(b,a,c){a.$on("newMessage",function(f,e){if(e.action=="newThread"){b.inboxThreads.unshift(e.message)}else{if(e.action=="newMessage"){for(var d=0;d<b.inboxThreads.length;d++){if(b.inboxThreads[d].threadId==e.message.threadId){if(currentMessageThreadId!=e.message.threadId){b.inboxThreads[d].haveNewMessage=true}b.inboxThreads[d].message=e.message.content;break}}}}b.$apply()});this.gotToConversation=function(d){a.$emit("loadConversation",d.userId)}}]);messageApp.controller("searchController",["$scope","$rootScope","$http",function(c,a,d){this.search=null;c.userSearchList=[];var b=document.forms.pp_message_api_get_search_user_form.action;this.searchUser=function(){if(this.search.length>0){d.get(b+"?search="+this.search).then(function(f){c.userSearchList=[];for(var e=0;e<f.data.users.length;e++){c.userSearchList.push(f.data.users[e])}},function(e){console.log("Request failed : "+e.statusText)})}else{c.userSearchList=[]}};this.getThread=function(e){a.$emit("loadConversation",e.id)}}]);messageApp.controller("chatController",["$scope","$rootScope","$http",function(b,a,c){this.messageContent=null;a.$on("loadConversation",function(e,d){readyForMessage=false;c.get(getThreadUrl+"?targetId="+d).then(function(f){haveMessageThread=f.data.messageThreadFounded;currentThread=f.data.messageThread;targetUser=f.data.targetUser;if(haveMessageThread){for(var g=0;g<b.inboxThreads.length;g++){if(b.inboxThreads[g].threadId==currentThread.threadId){b.inboxThreads[g].haveNewMessage=false;break}}}b.currentThread={targetName:targetUser.name};b.conversation=[];if(haveMessageThread){c.get(conversationUrl+"?threadId="+currentThread.threadId).then(function(h){b.conversation=h.data.messages},function(h){console.log("Request failed : "+h.statusText)})}readyForMessage=true},function(f){console.log("Request failed : "+f.statusText)})});a.$on("newMessage",function(e,d){if(currentThread!=null&&d.message.threadId==currentThread.threadId){b.conversation.push(d.message);b.$apply()}});this.sendMessage=function(){var f=null;if(currentThread!=null){f=currentThread.threadId}myData={haveMessageThread:haveMessageThread,targetUserId:targetUser.id,currentMessageThreadId:f,messageContent:this.messageContent};if(readyForMessage){c({method:"POST",url:postMessageUrl,data:JSON.stringify(myData)}).then(function(g){if(!haveMessageThread){currentThread=g.data.newThread;haveMessageThread=true;b.inboxThreads.unshift(g.data.newThread)}},function(g){console.log("Request failed : "+g.statusText)});var d={content:this.messageContent,authorName:currentUser.name,messageFromUs:true};b.conversation.push(d);if(currentThread!=null){for(var e=0;e<b.inboxThreads.length;e++){if(b.inboxThreads[e].threadId==currentThread.threadId){b.inboxThreads[e].message=this.messageContent;b.inboxThreads[e].messageFromUs=true;break}}}this.messageContent=null}}}]);