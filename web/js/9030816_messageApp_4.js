var appLoaded=false;var readyForMessage=true;var messageApp=angular.module("messageApp",["ngRoute","ngSanitize"]);messageApp.config(["$locationProvider",function(a){a.html5Mode(true)}]);messageApp.service("FayeClient",function(){return new Faye.Client("http://alexandrejolly.com:3000/")});messageApp.run(["$rootScope","FayeClient","$http",function(a,d,e){a.currentUser={};var b=document.forms.pp_message_api_get_current_user_form.action;var c=null;a.$on("showNewMessage",function(g,f){c=f;if(appLoaded){a.$emit("loadConversation",a.currentUser.threadList[c.id]);a.currentThread=a.currentUser.threadList[c.id]}});e.get(b).then(function(f){a.currentUser=f.data;d.subscribe("/messages/"+a.currentUser.id,function(g){a.$broadcast("newMessage",g)});if(c!=null){a.$emit("loadConversation",a.currentUser.threadList[c.id])}$(".chat-conversation").scrollTop($(".chat-conversation").height());appLoaded=true},function(f){console.log("Request failed : "+f.statusText)})}]);messageApp.controller("inboxController",["$scope","$rootScope","$http",function(b,a,c){a.$on("newMessage",function(e,d){if(d.action=="newThread"){a.currentUser.threadList[d.message.threadId]=d.newThread;a.currentUser.threadList[d.message.threadId].haveReceiveMessage=true}else{if(d.action=="newMessage"){}}b.$apply()});this.gotToConversation=function(d){a.$emit("loadConversation",d)}}]);messageApp.controller("searchController",["$scope","$rootScope","$http",function(c,a,d){this.search=null;c.userSearchList=[];var b=document.forms.pp_user_api_get_search_user_form.action;this.searchUser=function(){if(this.search.length>0){d.get(b+"?search="+this.search).then(function(f){c.userSearchList=[];for(var e=0;e<f.data.users.length;e++){c.userSearchList.push(f.data.users[e])}},function(e){console.log("Request failed : "+e.statusText)})}else{c.userSearchList=[]}};this.getThread=function(f){var e={target:f};a.$emit("loadConversation",e)}}]);messageApp.controller("chatController",["$scope","$rootScope","$http",function(e,b,g){e.conversation=[];e.messageContent=null;var a=function(){$("#conversation").scrollTop($("#conversation")[0].scrollHeight)};b.$on("loadConversation",function(j,h){var i=true;$("#chatTitle").html(h.target.name);if(h.id==null){i=false;for(var k in b.currentUser.threadList){if(b.currentUser.threadList[k].target.id==h.target.id){h=b.currentUser.threadList[k];i=true;e.currentThread=h;break}}if(!i){e.currentThread=h}}if(i){if(!b.currentUser.threadList[h.id].haveReceiveMessage&&(b.currentUser.threadList[h.id]==null||b.currentUser.threadList[h.id].messageList.length>0)){e.currentThread=h}else{if(i){b.currentUser.threadList[h.id].haveReceiveMessage=false;readyForMessage=false;g.get(b.currentUser.getConversationApiUrl+"?threadId="+h.id+"&page=1").then(function(l){e.currentThread=h;b.currentUser.threadList[h.id].haveNewMessage=false;b.currentUser.threadList[h.id].messageList=l.data.messages;setTimeout(a,10);readyForMessage=true},function(l){console.log("Request failed : "+l.statusText)})}}}if(!e.$$phase){e.$apply();$("#conversation").scrollTop($("#conversation")[0].scrollHeight)}setTimeout(a,10)});this.loadMore=function(){e.currentThread.page++;if(e.currentThread.id!=null){g.get(b.currentUser.getConversationApiUrl+"?threadId="+e.currentThread.id+"&page="+e.currentThread.page).then(function(h){for(var j=h.data.messages.length-1;j>-1;j--){b.currentUser.threadList[e.currentThread.id].messageList.unshift(h.data.messages[j])}},function(h){console.log("Request failed : "+h.statusText)})}};b.$on("newMessage",function(i,h){if(b.currentUser.threadList[h.message.threadId].messageList.length==0){b.currentUser.threadList[h.message.threadId].haveReceiveMessage=true}b.currentUser.threadList[h.message.threadId].messageList.push(h.message);b.currentUser.threadList[h.message.threadId].lastMessage=h.message;e.$apply();$("#conversation").scrollTop($("#conversation")[0].scrollHeight)});var f=function(){if(e.messageContent){myData={threadId:e.currentThread.id,targetId:e.currentThread.target.id,messageContent:e.messageContent};if(readyForMessage){var h={content:e.messageContent,authorName:b.currentUser.name,messageFromUs:true};if(e.currentThread.id!=null){b.currentUser.threadList[e.currentThread.id].messageList.push(h)}g({method:"POST",url:b.currentUser.postMessageApiUrl,data:JSON.stringify(myData)}).then(function(i){if(e.currentThread.id==null){e.currentThread=i.data.newThread;if(b.currentUser.threadList[i.data.newThread.id]==null){b.currentUser.threadList[i.data.newThread.id]=i.data.newThread}}},function(i){console.log("Request failed : "+i.statusText)});e.messageContent=null;setTimeout(a,10)}}};this.callSendMessage=function(){f()};var d=0;$("#chatTextArea").elastic();$("#chatTextArea").on("keydown",function(h){if(h.keyCode==13){if(!h.shiftKey){f()}else{setTimeout(a,10)}}});function c(){var k=document.getElementById("chatTextArea");var j=(k.cols);var h=(k.value.length/j);var i=(k.value.split("\r\n"));return Math.round(h)+1}}]);var isInSearch=false;$("#searchButton").click(function(){if(!isInSearch){$("#inboxBlock").css("display","none");$("#searchBlock").css("display","inline-block");isInSearch=true}else{$("#inboxBlock").css("display","block");$("#searchBlock").css("display","none");isInSearch=false}});